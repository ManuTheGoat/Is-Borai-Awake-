<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>is @borai awake?</title>
  <style>
    :root{--bg1:#0f1226;--bg2:#1a1f3b;--fg:#e9ecff;--muted:#b5b9d6;--yes:#3ddc84;--no:#ff6b6b;--card:#151935aa;--pill:#23284d;--shadow:0 10px 30px rgba(0,0,0,.35)}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;color:var(--fg);background:radial-gradient(1200px 800px at 80% -10%,#2e356b33 0%,transparent 50%),radial-gradient(1000px 700px at -10% 110%,#6f7cff18 0%,transparent 60%),linear-gradient(160deg,var(--bg1),var(--bg2));display:flex;align-items:center;justify-content:center;padding:24px}
    .wrap{width:min(900px,100%);text-align:center}
    .card{background:var(--card);backdrop-filter:blur(10px);border:1px solid #2a2f58;border-radius:24px;padding:28px;box-shadow:var(--shadow)}
    h1{font-size:clamp(28px,4vw,44px);margin:8px 0 4px;letter-spacing:0.4px;user-select:none}
    .hint{font-size:12px;color:var(--muted);letter-spacing:.2px}
    .status-pill{display:inline-flex;align-items:center;gap:10px;padding:10px 16px;border-radius:999px;background:var(--pill);border:1px solid #2d3361;font-weight:600;margin:16px 0 8px}
    .dot{width:10px;height:10px;border-radius:50%}
    .msg{color:var(--muted);margin:0 0 16px;min-height:20px}
    .control-row{margin-top:18px}
    .big-btn{background:#2f356c;color:var(--fg);border:0;padding:12px 18px;border-radius:12px;font-weight:700;cursor:pointer}
    .small{font-size:12px;color:var(--muted);margin-top:8px}
    .footer{margin-top:18px;font-size:12px;color:var(--muted)}
    @media (max-width:480px){.card{padding:18px}}
  </style>
</head>
<body>
  <main class="wrap">
    <div class="card">
      <div>
        <div class="hint">status dashboard</div>
        <h1 id="pageTitle">is @borai awake?</h1>
      </div>

      <div class="status-pill" id="statusPill" aria-live="polite" aria-atomic="true">
        <span class="dot" id="dot"></span>
        <span id="statusText"></span>
      </div>

      <p class="msg" id="subMsg"></p>

      <div class="control-row">
        <button id="authBtn" class="big-btn">Are you Borai?</button>
        <div class="small">Click to unlock the flip control (works on mobile & desktop)</div>
      </div>

      <div class="footer">
        <span class="small">This page syncs globally. Everyone sees the latest status.</span>
      </div>
    </div>
  </main>

  <script>
    const els = {
      dot: document.getElementById('dot'),
      text: document.getElementById('statusText'),
      msg: document.getElementById('subMsg'),
      authBtn: document.getElementById('authBtn')
    };

    const fmtTime = (d) => new Intl.DateTimeFormat(undefined, {hour:'numeric', minute:'2-digit', hour12:true}).format(d);

    async function fetchStatus(){
      const r = await fetch('/api/status', {cache:'no-store'});
      if(!r.ok) throw new Error('fetch failed');
      return r.json();
    }

    async function render(){
      try{
        const data = await fetchStatus();
        const asleep = data.status === 'no';
        els.dot.style.background = asleep ? getComputedStyle(document.documentElement).getPropertyValue('--no') : getComputedStyle(document.documentElement).getPropertyValue('--yes');
        els.text.textContent = asleep ? "No, I'm not awake." : "Yes, I'm awake.";
        if(asleep && data.bedISO){ els.msg.textContent = `went to bed at ${fmtTime(new Date(data.bedISO))}`; }
        else if(!asleep && data.wakeISO){ els.msg.textContent = `woke up at ${fmtTime(new Date(data.wakeISO))}`; }
        else { els.msg.textContent = ''; }
      }catch(e){
        console.error(e);
      }
    }

    async function flipFlow(){
      const a = prompt('Enter secret');
      if(a===null) return;
      const r0 = await fetch('/api/status');
      const cur = await r0.json();
      const action = cur.status === 'yes' ? 'sleep' : 'wake';
      const r = await fetch('/api/status', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ action, secret: a })
      });
      if(r.ok){ await render(); }
      else{
        const {error} = await r.json().catch(()=>({error:'error'}));
        alert(error || 'Failed');
      }
    }

    els.authBtn.addEventListener('click', flipFlow);

    render();
    setInterval(render, 10000);
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) render(); });
  </script>
</body>
</html>
